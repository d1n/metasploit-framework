## MS15-001 Microsoft Windows NtApphelpCacheControl Improper Authorization Check

On Windows, the system call NtApphelpCacheControl (the code 
is actually in ahcache.sys) allows application compatibility 
data to be cached for quick reuse when new processes are 
created. A normal user can query the cache but cannot add 
new cached entries as the operation is restricted to 
administrators. This is checked in the function 
AhcVerifyAdminContext. This function has a vulnerability 
where it doesn't correctly check the impersonation token of 
the caller to determine if the user is an administrator. It 
reads the caller's impersonation token using 
PsReferenceImpersonationToken and then does a comparison 
between the user SID in the token to LocalSystem's SID. It 
doesn't check the impersonation level of the token so it's 
possible to get an identify token on your thread from a 
local system process and bypass this check. This module 
currently only affects Windows 8 and Windows 8.1, and 
requires access to C:\Windows\System\ComputerDefaults.exe 
(although this can be improved).


## Module Name
exploit/windows/local/ntapphelpcachecontrol

## Authors
* James Forshaw
* sinn3r


## References
* http://technet.microsoft.com/en-us/security/bulletin/MS15-001
* http://cvedetails.com/cve/2015-0002/
* OSVEB (116497)
* https://www.exploit-db.com/exploits/35661
* https://code.google.com/p/google-security-research/issues/detail?id=118



## Targets
* Windows 8 / Windows 8.1 (x86 and x64)


## Platforms
win

## Reliability
[Normal](https://github.com/rapid7/metasploit-framework/wiki/Exploit-Ranking)

## Demo

```
msf > use exploit/windows/local/ntapphelpcachecontrol
msf exploit(ntapphelpcachecontrol) > show targets
   ... a list of targets ...
msf exploit(ntapphelpcachecontrol) > set TARGET <target-id>
msf exploit(ntapphelpcachecontrol) > show options
   ... show and set options ...
msf exploit(ntapphelpcachecontrol) > run
```
    
    