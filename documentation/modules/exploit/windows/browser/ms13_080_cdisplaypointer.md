## MS13-080 Microsoft Internet Explorer CDisplayPointer Use-After-Free

This module exploits a vulnerability found in Microsoft 
Internet Explorer. It was originally found being exploited 
in the wild targeting Japanese and Korean IE8 users on 
Windows XP, around the same time frame as CVE-2013-3893, 
except this was kept out of the public eye by multiple 
research companies and the vendor until the October patch 
release. This issue is a use-after-free vulnerability in 
CDisplayPointer via the use of a "onpropertychange" event 
handler. To set up the appropriate buggy conditions, we 
first craft the DOM tree in a specific order, where a 
CBlockElement comes after the CTextArea element. If we use a 
select() function for the CTextArea element, two important 
things will happen: a CDisplayPointer object will be created 
for CTextArea, and it will also trigger another event called 
"onselect". The "onselect" event will allow us to set up for 
the actual event handler we want to abuse - the 
"onpropertychange" event. Since the CBlockElement is a child 
of CTextArea, if we do a node swap of CBlockElement in 
"onselect", this will trigger "onpropertychange". During 
"onpropertychange" event handling, a free of the 
CDisplayPointer object can be forced by using an "Unslect" 
(other approaches also apply), but a reference of this freed 
memory will still be kept by CDoc::ScrollPointerIntoView, 
specifically after the CDoc::GetLineInfo call, because it is 
still trying to use that to update CDisplayPointer's 
position. When this invalid reference arrives in QIClassID, 
a crash finally occurs due to accessing the freed memory. By 
controlling this freed memory, it is possible to achieve 
arbitrary code execution under the context of the user.


## Module Name
exploit/windows/browser/ms13_080_cdisplaypointer

## Authors
* Unknown
* sinn3r


## References
* http://cvedetails.com/cve/2013-3897/
* http://www.osvdb.org/98207
* http://technet.microsoft.com/en-us/security/bulletin/MS13-080
* http://blogs.technet.com/b/srd/archive/2013/10/08/ms13-080-addresses-two-vulnerabilities-under-limited-targeted-attacks.aspx
* http://jsunpack.jeek.org/?report=847afb154a4e876d61f93404842d9a1b93a774fb



## Targets
* Automatic
* IE 7 on Windows XP SP3
* IE 8 on Windows XP SP3
* IE 8 on Windows 7


## Platforms
win

## Reliability
[Normal](https://github.com/rapid7/metasploit-framework/wiki/Exploit-Ranking)

## Demo

```
msf > use exploit/windows/browser/ms13_080_cdisplaypointer
msf exploit(ms13_080_cdisplaypointer) > show targets
   ... a list of targets ...
msf exploit(ms13_080_cdisplaypointer) > set TARGET <target-id>
msf exploit(ms13_080_cdisplaypointer) > show options
   ... show and set options ...
msf exploit(ms13_080_cdisplaypointer) > run
```
    
    